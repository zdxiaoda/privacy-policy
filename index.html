<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Privacy Policy | zd小达's Websites</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      href="https://cdn.xiaoda.fun/image/avatar/zdxiaoda.webp" />
    <link rel="stylesheet" href="./style.css" />
  </head>

  <body>
    <div id="policy-content"></div>
    <div class="footer">
      <hr color="#d9d9d9" />
      <div class="language-switch">
        <span>Language / 语言 / 言語:</span>
        <button data-lang="en">English</button>
        <button data-lang="zh">中文</button>
        <button data-lang="ja">日本語</button>
      </div>
      <p>© 2025 zd小达</p>
    </div>
    <script>
      const policies = {};
      const cache = {};
      const contentEl = document.getElementById("policy-content");
      const langButtons = document.querySelectorAll("[data-lang]");
      const availableLangs = ["en", "zh", "ja"];
      const applyEnFallback = (loadedLang) => {
        if (cache.en?.policy && loadedLang !== "en") policies.en = cache.en.policy;
      };

      const detectLanguage = () => {
        const stored = localStorage.getItem("policyLang");
        if (stored && availableLangs.includes(stored)) return stored;

        const browserLang = (navigator.language || "").toLowerCase();
        if (browserLang.startsWith("zh")) return "zh";
        if (browserLang.startsWith("ja")) return "ja";
        if (browserLang.startsWith("en")) return "en";
        return "en";
      };

      const renderPolicy = (lang) => {
        const policy = policies[lang] || policies.en || {};
        document.documentElement.lang = policy.langAttr || "en";
        if (policy.title) document.title = policy.title;
        contentEl.innerHTML = policy.content || "";
        langButtons.forEach((btn) => {
          btn.classList.toggle("lang-active", btn.dataset.lang === lang);
        });
      };

      const loadLanguage = (lang) => {
        if (cache[lang]) return Promise.resolve(cache[lang]);
        const path = `./language-${lang}.json`;
        return fetch(path)
          .then((res) =>
            res.ok ? res.json() : Promise.reject(new Error(`Failed to load ${path}`))
          )
          .then((data) => {
            cache[lang] = data;
            return data;
          });
      };

      const applyLanguage = (lang) => {
        const load = (target) =>
          loadLanguage(target).then((data) => ({ lang: target, data }));

        const loadInOrder = (list) =>
          load(list[0]).catch(() =>
            list.length > 1 ? loadInOrder(list.slice(1)) : Promise.reject()
          );

        const order = lang === "en" ? ["en"] : [lang, "en"];

        loadInOrder(order)
          .then(({ lang: loadedLang, data }) => {
            if (data.policy) policies[loadedLang] = data.policy;
            applyEnFallback(loadedLang);
            renderPolicy(data.policy ? loadedLang : "en");
          })
          .catch(() => renderPolicy("en"));
      };

      applyLanguage(detectLanguage());

      langButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetLang = btn.dataset.lang;
          localStorage.setItem("policyLang", targetLang);
          applyLanguage(targetLang);
        });
      });
    </script>
  </body>
  <!--字体-->
  <link
    href="https://cdn.xiaoda.fun/static/fonts/KingHwaOldSong/result.css"
    rel="stylesheet" />
</html>
